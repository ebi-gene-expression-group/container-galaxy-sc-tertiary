<tool id="ucsc-cell-browser" name="UCSC Cell Browser" version="0.4.23+galaxy0">
  <requirements>
    <requirement type="package" version="0.4.23">ucsc-cell-browser</requirement>
  </requirements>
<stdio>
<exit_code range="1:" />
</stdio>
<description>Runs the UCSC Cell Browser interactively</description>
<command><![CDATA[
#if $input_type.expression_source == "native-cell-browser":

echo "coords = [ {'file':'$tsneCoordinates', 'shortLabel':'t-SNE on WGCNA'} ]" > ./cellbrowser.conf;
echo "meta = '$cellMetadata'" >> ./cellbrowser.conf;
echo "name = 'sample'" >> ./cellbrowser.conf;
echo "exprMatrix = '$expressionMatrix'" >> ./cellbrowser.conf;
echo "geneIdType = 'symbol'" >> ./cellbrowser.conf;

cbBuild -i cellbrowser.conf -o "$html_file.extra_files_path";
mv "$html_file.extra_files_path"/index.html "$html_file";

#else if $input_type.expression_source == "scanpy":

ln -s '$input_anndata_file' scanpy_ann_data.h5ad;
cbImportScanpy scanpy_ann_data.h5ad '$html_file.extra_files_path' sample --htmlDir "$html_file.extra_files_path";
mv "$html_file.extra_files_path"/index.html "$html_file";

#else if $input_type.expression_source == "seurat":

ln -s '$input_rds_file' seurat.rds;
ls -l seurat.rds;
mkdir -p '$html_file.extra_files_path';
#if $input_type.metadata_fields:
  cbImportSeurat --outDir '$html_file.extra_files_path' --name 'sample' seurat.rds --meta $input_type.metadata_fields;
  all_metadata_fields='$input_type.metadata_fields';
#else:
  all_metadata_fields=\$(Rscript $get_seurat_metadata_fields seurat.rds);
  cbImportSeurat --outDir '$html_file.extra_files_path' --name 'sample' seurat.rds --meta \$all_metadata_fields;
#end if
ls -l '$html_file.extra_files_path';
clusterField=\$(echo \$all_metadata_fields | awk '{for (i=1;i<=NF;i++){if (\$i ~/res/) {print \$i}}}');
echo "coords = [ {'file': '$html_file.extra_files_path/tsne.coords.tsv', 'shortLabel': 't-SNE Seurat Processed' }]" > ./cellbrowser.conf;
echo "name = 'sample'" >> ./cellbrowser.conf;
echo "clusterField = '"\$clusterField"'" >> ./cellbrowser.conf;
for field in \$all_metadata_fields; do
  if [[ \$field == res.* ]] ;
  then
    echo "forceEnum = ['"\$field"']" >> ./cellbrowser.conf;
  fi
done;
echo "meta = '$html_file.extra_files_path/meta.tsv'" >> ./cellbrowser.conf;
echo "exprMatrix = '$html_file.extra_files_path/exprMatrix.tsv'" >> ./cellbrowser.conf;
echo "geneIdType = 'symbol'" >> ./cellbrowser.conf;
cbBuild -i ./cellbrowser.conf -o "$html_file.extra_files_path";
mv "$html_file.extra_files_path"/index.html "$html_file";

#end if
]]></command>
<configfiles>
        <configfile name="get_seurat_metadata_fields"><![CDATA[
#!/usr/bin/env Rscript
suppressPackageStartupMessages(require(data.table))
args = commandArgs(trailingOnly=TRUE)
# Input from serialized R object
seurat_object <- readRDS(args[1])
cat(colnames(seurat_object@meta.data))
]]></configfile>
    </configfiles>
<inputs>
  <conditional name="input_type">
    <param type="select" name="expression_source" label="Choose the format of the expression data" help="Use compressed txt, Scanpy or Seurat objects">
      <option value="native-cell-browser" selected="true">CellBrowser tar.gz expression matrix</option>
      <option value="scanpy">Scanpy AnnData HDF5 serialized object</option>
      <option value="seurat">Seurat R-serialized object</option>
    </param>
    <when value="native-cell-browser">
      <param type="data" name="expressionMatrix" label="Expression matrix" help="Tabular expression matrix (see https://github.com/maximilianh/cellBrowser/tree/master/sampleData)" format="tabular"/>
      <param type="data" name="cellMetadata" label="Cell metadata" help="Tabular file with metadata fields (columns) for each cell (rows)." format="tabular"/>
      <param type="data" name="tsneCoordinates" label="tSNE coordinates" help="Tabular file with tSNE coordinates for each cell." format="tabular"/>
    </when>
    <when value="scanpy">
      <param name="input_anndata_file" type="data" format="h5" label="Input object in AnnData hdf5 format" help="Scanpy serialized output is by default produced as an AnnData hdf5 file."/>
    </when>
    <when value="seurat">
      <param name="input_rds_file" type="data" format="rdata" label="RDS object from Seurat 2"/>
      <param name="metadata_fields" type="text" value="" label="Metadata fields to extract from Seurat 2 RDS" help="Space separated list of fields, if blank all metadata fields available in the Seurat object are used."/>
    </when>
  </conditional>
</inputs>
<outputs>
    <data format="html" name="html_file" label="Interactive UCSC Cell Browser"/>
</outputs>
<help><![CDATA[
UCSC Single Cell Browser
========================

Funded by the California Institute of Regenerative Medicine and the Chan-Zuckerberg
Initiative https://www.chanzuckerberg.com/.

The UCSC Cell Browser is a viewer for single cell data. You can click on and hover
over cells to get meta information, search for genes to color on and click clusters
to show cluster-specific marker genes, which in turn are clickable again.

For a demo of the browser, see http://cells.ucsc.edu

Usage
-----

After choosing the inputs and executing the tool, once the history item becomes
green, press the View data (eye icon) button, which will open the generated UCSC Cell Browser
interactive site. Press the white on blue "Open Dataset" button.

Troubleshooting
---------------

Depending on the window size when pressing the "View data" button, you might see a black canvas and a diminished panel to the upper left
with the text "Choose cell...". If that is the case, close that panel (click on the cross)
and then choose File -> Open Dataset... and then press the Open Dataset white button.

Version history
---------------

0.4.3+galaxy0: Initial contribution by the Expression Atlas team https://www.ebi.ac.uk/gxa/home  at
EMBL-EBI https://www.ebi.ac.uk/
]]></help>
</tool>
