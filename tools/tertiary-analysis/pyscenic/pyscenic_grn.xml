<tool id="pyscenic_grn" name="PySCENIC GRN" version="0.12.1+galaxy0" profile="21.09">
    <description>Gene regulatory network inference using PySCENIC</description>
    <requirements>
        <container type="docker">
            aertslab/pyscenic:0.12.1
        </container>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[
        ln -s ${expression_mtx} expr_mat.loom && 
        ln -s ${tfs_fname} tfs.txt &&
        pyscenic grn 
            -o tf2targets.tsv
            #if $transpose
            -t
            #end if
            #if $method
            -m "${method}"
            #end if
            #if $seed
            --seed "${seed}"
            #end if
            --num_workers \${GALAXY_SLOTS:-1}
            #if $cell_id_attribute
            --cell_id_attribute "${cell_id_attribute}"
            #end if
            #if $gene_attribute
            --gene_attribute "${gene_attribute}"
            #end if
            #if $sparse
            --sparse
            #end if
            expr_mat.loom tfs.txt &&
            mv tf2targets.tsv '${tf2targets}'
        ]]>
    </command>
    <inputs>
        <param name="expression_mtx" type="data" format="loom" label="Expression Matrix Loom File" help="In format rows=genes x columns=cells" />
        <param name="tfs_fname" type="data" format="txt" label="Transcription Factors File" help="Simple text file, one transcription factor symbol per line"/>
        <param name="transpose" type="boolean" default_value="false" label="Transpose Expression Matrix" />
        <param name="method" type="select" label="Method">
            <option value="genie3">GENIE3</option>
            <option value="grnboost2" selected="true">GRNBoost2</option>
        </param>
        <param name="cell_id_attribute" type="text" optional="true" label="Cell ID Attribute" />
        <param name="gene_attribute" type="text" optional="true" label="Gene Attribute" />
        <param name="sparse" type="boolean" optional="true" label="Load as Sparse Matrix" />
        <param name="seed" type="integer" optional="true" label="Seed" />
    </inputs>
    <outputs>
        <data name="tf2targets" format="tsv" label="${tool.name} on ${on_string}: gene regulatory network"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="expression_mtx" value="expr_mat.loom"/>
            <param name="tfs_fname" value="allTFs_hg38.txt"/>
            <param name="seed" value="1"/>
            <output name="tf2targets" > <!-- file="tf2targets.tsv" compare="sim_size" delta_frac="0.2"/> -->
                <assert_contents>
                    <has_n_lines n="1006973"/>
                </assert_contents>
            </output>
        </test>

    </tests>
    <help><![CDATA[
        This tool runs the `pyscenic grn` command to infer gene regulatory networks.

        **Inputs:**

        - Expression Matrix File: Loom file containing the expression matrix, (rows=genes x columns=cells)
        - Transcription Factors File: TXT file with a list of transcription factors.
        
        **Options:**

        - Output File: Path to the output file (CSV format).
        - Transpose Expression Matrix: If selected, transpose the expression matrix.
        - Method: Algorithm for gene regulatory network reconstruction (default: GRNBoost2).
        - Seed: Seed value for random state initialization.
        - Number of Workers: Number of workers to use for computation.
        - Client or Address: Client or IP address of the dask scheduler.
        - Cell ID Attribute: Column attribute for cell identifiers in the loom file.
        - Gene Attribute: Row attribute for gene symbols in the loom file.
        - Load as Sparse Matrix: Load the expression data as a sparse matrix.
    ]]></help>
    <citations>
        <citation type="doi">10.1038/nmeth.4463</citation>
    </citations>
</tool>