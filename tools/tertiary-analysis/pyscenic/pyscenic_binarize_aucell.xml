<tool id="pyscenic_binarize" name="PySCENIC Binarize AUCell" profile="21.09" version="@TOOL_VERSION@+galaxy0">
    <description>defines AUCell thresholds and tags cells as passing it or not</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code">
        <![CDATA[
        ln -s $input_file aucell.tsv &&
        python '$__tool_directory__/pyscenic_binarize_aucell.py'
        #if $threshold_overrides
            --threshold-overrides '$threshold_overrides'
        #end if
        #if $seed
            --seed '$seed'
        #end if
        --num-workers \${GALAXY_SLOTS:-1}
        --output-prefix ./
        aucell.tsv
        ]]>
    </command>
    <inputs>
        <param name="input_file" type="data" format="tabular,txt" label="Input AUC matrix"/>
        <param name="threshold_overrides" type="text" optional="true" label="Threshold overrides in JSON format" help="Override default threshold values for binarization"/>
        <param name="seed" type="integer" optional="true" label="Random seed"/>
    </inputs>
    <outputs>
        <data name="binarized_mtx" format="tsv" label="${tool.name} on ${on_string}: Binarized AUC matrix" from_work_dir="binarized_mtx.tsv"/>
        <data name="thresholds" format="tsv" label="${tool.name} on ${on_string}: Binarization thresholds" from_work_dir="thresholds.tsv"/>
    </outputs>
    <tests>
        <test>
            <param name="input_file" value="aucell_test_smaller.tsv"/>
            <param name="seed" value="10"/>
            <output name="binarized_mtx">
                <assert_contents>
                    <has_text_matching expression="D124DE\t0\t1"/>
                    <has_n_lines n="5001"/>
                </assert_contents>
            </output>
            <output name="thresholds">
                <assert_contents>
                    <has_text text="AUCell_1"/>
                    <has_n_lines n="3"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help>
        <![CDATA[
        **What it does**

        This tool binarizes an AUC matrix using the `binarize` function from the `pySCENIC` package. 
        It produces a classification of the cell per given AUCell into passing or not passing an
        automatically defined threshold, through binarization (when possible) of the AUCell distribution.
        See the SCENIC paper or the PySCENIC notebooks for more details.

        **Input**

        - Input AUC matrix (TSV): The AUC matrix to be binarized (first column expected to be cell identifiers).
        - Threshold overrides in JSON format (optional): Override default threshold values for binarization.
        - Random seed (optional): Seed for random number generation.

        **Output**

        - Binarized AUC matrix: The binarized AUC matrix.
        - Binarization thresholds: The threshold values used for binarization.

        **Example**

        Input AUC matrix (tsv file, as generated by the PySCENIC AUCell or Decoupler AUCell tools):
        ```
                 AUCellA  AUCellB  AUCellC
        cell1    0.024    0.045    0.001
        cell2    0.136    0.024    0.045
        cellN    0.001    0.347    0.136
        ```
        ]]>
    </help>
    <expand macro="citations"/>
</tool>
