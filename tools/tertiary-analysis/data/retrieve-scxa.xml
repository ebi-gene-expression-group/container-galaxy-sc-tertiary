<?xml version="1.0" encoding="utf-8"?>
<tool id="retrieve-scxa" name="EBI Expression Atlas Single Cell Data Retrieval" version="v0.0.1+galaxy1">
  <description>from single cell expression atlas</description>
  <requirements>
    <requirement type="package" version="1.18">gnu-wget</requirement>
  </requirements>
  <command detect_errors="exit_code"><![CDATA[

#if str($matrix_type) == "tpm":

wget -O exp_quant.zip
    'https://www.ebi.ac.uk/gxa/sc/experiment/${accession}/download/zip?fileType=quantification-filtered&accessKey=' &&
unzip exp_quant.zip;
mv ${accession}.expression_tpm.mtx ${matrix_mtx} &&
awk '{OFS="\t"; print \$2,\$2}' ${accession}.expression_tpm.mtx_rows > ${genes_tsv} &&
cut -f2 ${accession}.expression_tpm.mtx_cols > ${barcode_tsv};

#else if str($matrix_type) == "raw":

wget -O ${matrix_mtx} 'ftp://ftp.ebi.ac.uk/pub/databases/microarray/data/atlas/sc_experiments/${accession}/${accession}.aggregated_filtered_counts.mtx';
wget -qO - 'ftp://ftp.ebi.ac.uk/pub/databases/microarray/data/atlas/sc_experiments/${accession}/${accession}.aggregated_filtered_counts.mtx_cols' | cut -f2 > ${barcode_tsv};
wget -qO - 'ftp://ftp.ebi.ac.uk/pub/databases/microarray/data/atlas/sc_experiments/${accession}/${accession}.aggregated_filtered_counts.mtx_rows'
 | awk '{OFS="\t"; print \$2,\$2}' > ${genes_tsv};

#end if

wget -O exp_design.tsv
    'https://www.ebi.ac.uk/gxa/sc/experiment/${accession}/download?fileType=experiment-design&accessKey=';

]]></command>

  <inputs>
    <param name="accession" type="text" value="E-GEOD-100058" label="SC-Atlas experiment accession"/>
    <param name="matrix_type" type="select" label="Choose the type of matrix to download">
      <option value="raw" selected="true">Raw filtered counts</option>
      <option value="tpm">Filtered TPMs</option>
    </param>
  </inputs>

  <outputs>
    <data name="matrix_mtx" format="txt" label="${tool.name} on ${on_string} ${accession} matrix.mtx (${matrix_type.value_label})"/>
    <data name="genes_tsv" format="tsv" label="${tool.name} on ${on_string} ${accession} genes.tsv (${matrix_type.value_label})"/>
    <data name="barcode_tsv" format="tsv" label="${tool.name} on ${on_string} ${accession} barcodes.tsv (${matrix_type.value_label})"/>
    <data name="design_tsv" format="tsv" from_work_dir="exp_design.tsv" label="${tool.name} on ${on_string} ${accession} exp_design.tsv"/>
  </outputs>

  <tests>
    <test>
      <param name="accession" value="E-GEOD-100058"/>
      <output name="matrix_mtx" file="E-GEOD-100058.expression_tpm.mtx" ftype="txt"/>
      <output name="genes_tsv" file="E-GEOD-100058.genes.tsv" ftype="tsv"/>
      <output name="barcode_tsv" file="E-GEOD-100058.barcodes.tsv" ftype="tsv"/>
      <output name="design_tsv" file="E-GEOD-100058.exp_design.tsv" ftype="tsv"/>
    </test>
  </tests>

  <help><![CDATA[
For more information check https://www.ebi.ac.uk/gxa/sc/home
]]></help>
  <citations>
    <citation type="doi">10.1093/nar/gkv1045</citation>
  </citations>
</tool>
